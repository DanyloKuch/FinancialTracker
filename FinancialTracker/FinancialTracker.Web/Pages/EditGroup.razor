@using FinancialTracker.Web.Models
@using FinancialTracker.Web.Services
@inject FinancialService FinancialService

@if (IsVisible && Group != null)
{
    <div class="edit-group-overlay" @onclick="HandleOverlayClick">
        <div class="edit-group-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Редагувати групу</h3>
                <span class="cancel-link" @onclick="Close">Скасувати</span>
            </div>

            <div class="modal-body">
                <label>Назва групи</label>
                <input type="text" @bind="editedName" placeholder="Змінити назву групи" />

                <label>Оберіть валюту</label>
                <select class="currency-select" value="@editedCurrency" @onchange="HandleCurrencyChange">
                    <option value="UAH">₴ Українська гривня</option>
                    <option value="USD">$ Долар США</option>
                    <option value="EUR">€ Євро</option>
                </select>

                <div class="invite-section">
                    <label>Запросити учасників</label>
                    <span class="mail-icon">✉</span>
                </div>
                <div class="email-input-container">
                    <input type="email"
                           @bind="newEmail"
                           @bind:event="oninput"
                           @onkeypress="HandleEmailKeyPress"
                           placeholder="Введіть email учасника" />
                </div>

                <div class="email-tags">
                    @if (editedParticipants != null && editedParticipants.Any())
                    {
                        @foreach (var email in editedParticipants.ToList())
                        {
                            <div class="email-tag">
                                <span>@email</span>
                                <span class="remove-tag" @onclick="() => RemoveParticipant(email)">×</span>
                            </div>
                        }
                    }
                </div>

                <div class="copy-link">
                    <span>🔗 Скопіювати посилання для запрошення</span>
                </div>

                <button class="btn-save" @onclick="SaveGroup">Зберегти</button>
                <button class="btn-delete" @onclick="DeleteGroup">Видалити</button>
            </div>
        </div>
    </div>
}



@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public GroupDto? Group { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<GroupDto> OnSave { get; set; }
    [Parameter] public EventCallback<string> OnDelete { get; set; }

    private string editedName = "";
    private string editedCurrency = "UAH";
    private List<string> editedParticipants = new List<string>(); 
    private string newEmail = "";
    private string _lastGroupId = "";

    protected override void OnParametersSet()
    {
        if (IsVisible && Group != null && _lastGroupId != Group.Id)
        {
            editedName = Group.Name ?? "";
            editedCurrency = !string.IsNullOrEmpty(Group.BaseCurrency) ? Group.BaseCurrency : "UAH";
            editedParticipants = new List<string>(Group.ParticipantNames ?? new List<string>());
            _lastGroupId = Group.Id;
        }

        if (!IsVisible)
        {
            _lastGroupId = "";
            newEmail = "";
        }
    }

    private void HandleEmailKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddParticipant();
        }
    }

    private void AddParticipant()
    {
        if (!string.IsNullOrWhiteSpace(newEmail) && !editedParticipants.Contains(newEmail))
        {
            editedParticipants.Add(newEmail);
            newEmail = "";
            StateHasChanged();
        }
    }

    private void RemoveParticipant(string email)
    {
        editedParticipants.Remove(email);
        StateHasChanged();
    }

    private async Task SaveGroup()
    {
        if (Group == null) return;

        var groupIdCopy = Group.Id;
        var existingParticipantsCopy = Group.ParticipantNames != null
            ? new List<string>(Group.ParticipantNames)
            : new List<string>();

        try
        {
            if (!string.IsNullOrWhiteSpace(newEmail))
            {
                AddParticipant();
            }

            var updated = new GroupDto
                {
                    Id = groupIdCopy,
                    Name = editedName,
                    BaseCurrency = editedCurrency,
                    TotalLimit = Group.TotalLimit,
                    CreatedAt = Group.CreatedAt
                };

            await OnSave.InvokeAsync(updated);

            var modalEmails = editedParticipants ?? new List<string>();

            var newParticipants = modalEmails
                .Where(p => !string.IsNullOrWhiteSpace(p) && !existingParticipantsCopy.Contains(p))
                .ToList();

            if (newParticipants.Any())
            {
                foreach (var email in newParticipants)
                {
                    if (string.IsNullOrEmpty(groupIdCopy)) continue;

                    var inviteRequest = new InviteUserRequest
                        {
                            GroupId = Guid.Parse(groupIdCopy),
                            Email = email
                        };

                    await FinancialService.SendInvitationAsync(inviteRequest);
                }
            }

            Close();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] ПОМИЛКА: {ex.Message}");
        }
    }
    private void HandleCurrencyChange(ChangeEventArgs e)
    {
        editedCurrency = e.Value?.ToString() ?? "UAH";
    }

    private async Task DeleteGroup()
    {
        if (Group != null)
        {
            await OnDelete.InvokeAsync(Group.Id);
        }
    }

    private void HandleOverlayClick() => Close();

    private void Close()
    {
        _lastGroupId = "";
        newEmail = "";
        OnClose.InvokeAsync();
    }
}