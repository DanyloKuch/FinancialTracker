@using FinancialTracker.Web.Models
@using FinancialTracker.Web.Services
@inject FinancialService FinancialService

@if (IsVisible)
{
    <div class="edit-group-overlay" @onclick="Close">
        <div class="edit-group-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>Додати учасників</h3>
                <span class="cancel-link" @onclick="Close">Скасувати</span>
            </div>

            <div class="modal-body">
                <div class="invite-section">
                    <label>Електронна пошта</label>
                    <span class="mail-icon">✉</span>
                </div>

                <div class="email-input-container">
                    <input type="email"
                           @bind="newEmail"
                           @bind:event="oninput"
                           @onkeypress="HandleEmailKeyPress"
                           placeholder="Введіть email та натисніть Enter" />
                </div>

                <div class="email-tags">
                    @foreach (var email in pendingEmails)
                    {
                        <div class="email-tag">
                            <span>@email</span>
                            <span class="remove-tag" @onclick="() => RemoveEmail(email)">×</span>
                        </div>
                    }
                </div>

                @if (!string.IsNullOrEmpty(successMessage))
                {
                    <div class="success-message" style="color: #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; border: 1px solid #2ecc71; text-align: center;">
                        ✅ @successMessage
                    </div>
                }

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="error-message" style="color: #ff4444; background: rgba(255, 68, 68, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; border: 1px solid #ff4444; text-align: center;">
                        ⚠️ @errorMessage
                    </div>
                }

                <button class="btn-save"
                        @onclick="SendAllInvites"
                        disabled="@(string.IsNullOrWhiteSpace(newEmail) && !pendingEmails.Any())">
                    Надіслати запити @(pendingEmails.Count > 0 ? $"({pendingEmails.Count})" : "")
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string GroupId { get; set; } = "";
    [Parameter] public EventCallback OnClose { get; set; }

    private string newEmail = "";
    private string? errorMessage;
    private string? successMessage;
    private List<string> pendingEmails = new List<string>();

    private void HandleEmailKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            AddEmailToPending();
        }
    }

    private void AddEmailToPending()
    {
        errorMessage = null;
        if (!string.IsNullOrWhiteSpace(newEmail))
        {
            var email = newEmail.Trim();
            if (pendingEmails.Contains(email))
            {
                errorMessage = "Цей email вже доданий до списку нижче.";
                return;
            }

            if (email.Contains("@"))
            {
                pendingEmails.Add(email);
                newEmail = "";
                StateHasChanged();
            }
            else
            {
                errorMessage = "Некоректний формат електронної пошти.";
            }
        }
    }

    private void RemoveEmail(string email) => pendingEmails.Remove(email);

    private async Task SendAllInvites()
    {
        if (!string.IsNullOrWhiteSpace(newEmail)) AddEmailToPending();
        if (!pendingEmails.Any()) return;

        errorMessage = null;
        successMessage = null;
        bool hasAnyError = false;
        int successCount = 0;
        var emailsToProcess = pendingEmails.ToList();

        foreach (var email in emailsToProcess)
        {
            try
            {
                var request = new InviteUserRequest
                    {
                        GroupId = Guid.Parse(GroupId),
                        Email = email
                    };

                await FinancialService.SendInvitationAsync(request);
                pendingEmails.Remove(email);
                successCount++;

                StateHasChanged();
            }
            catch (Exception ex)
            {
                hasAnyError = true;
                errorMessage = ex.Message;

                if (ex.Message.Contains("вже є учасником") || ex.Message.Contains("вже надіслано"))
                {
                    pendingEmails.Remove(email);
                }
                StateHasChanged();
            }
        }

        if (successCount > 0)
        {
            successMessage = successCount == 1
                ? "Запрошення успішно надіслано!"
                : $"Успішно надіслано запрошень: {successCount}";

            StateHasChanged();
        }

        if (!hasAnyError && !pendingEmails.Any())
        {
            await Task.Delay(2000);
            Close();
        }
    }

    private void Close()
    {
        newEmail = "";
        errorMessage = null;
        successMessage = null;
        pendingEmails.Clear();
        OnClose.InvokeAsync();
    }

    private void CopyInviteLink() {  }
}