@page "/limits-setup"
@using FinancialTracker.Web.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<div class="setup-wrapper">
    <div class="setup-header">
        <div class="header-left">
        <span class="back-arrow" @onclick='() => Navigation.NavigateTo("/")'>←</span>
        </div>

        <div class="header-center">
        <h2>Налаштування лімітів</h2>
        </div>
    
    <div class="header-right">
            <button class="add-cat-btn-huge" @onclick="() => showCreateModal = true">+</button>
    </div>
    </div>
    <div class="plan-summary">
        <div class="plan-text">
            <span>Планові витрати</span>
            <span class="total-amount">@categories.Sum(c => c.TotalLimit).ToString("N0") ₴</span>
        </div>
        <div class="multi-progress">
            @foreach (var cat in categories.Where(c => c.TotalLimit > 0))
            {
                <div class="progress-segment"
                     style="width: @(GetGlobalPercent(cat))%; background-color: @GetCategoryColor(cat.Name);">
                </div>
            }
        </div>
    </div>
    <div class="categories-grid">
        @foreach (var cat in categories)
        {
            <div class="cat-card" @onclick="() => OpenEditModal(cat)" style="cursor: pointer;">
                <div class="cat-info">
                    <div class="icon-circle" style="border-color: @GetCategoryColor(cat.Name)">
                        @GetCategoryEmoji(cat.Name)
                    </div>
                    <span class="cat-label">@cat.Name</span>
                </div>

                <div class="input-container">
                    <div class="limit-display">
                        <span class="limit-value">@cat.TotalLimit.ToString("N0")</span>
                        <span class="currency-label">₴</span>
                        <div class="input-line"></div>
                    </div>
                </div>
            </div>
        }
    </div>
    <EditCategoryModal IsVisible="showEditModal"
                       Category="selectedCategory"
                       OnClose="CloseModal"
                       OnSave="UpdateCategory" />

    <CreateCategoryModal IsVisible="showCreateModal"
                         OnClose="() => showCreateModal = false"
                         OnSave="CreateNewCategory" />

    <button class="btn-continue" @onclick="SaveAllLimits">Продовжити</button>
</div>


@code {
    private List<CategoryDto> categories = new();
    private bool showEditModal = false;
    private CategoryDto selectedCategory = new();
    private bool showCreateModal = false;

    private void OpenEditModal(CategoryDto cat)
    {
        selectedCategory = cat; 
        showEditModal = true;
    }
    private async Task CreateNewCategory(CategoryDto newCat)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/v1/categories", newCat);

            if (response.IsSuccessStatusCode)
            {
                CategoryDto? created = null;
                try
                {
                    created = await response.Content.ReadFromJsonAsync<CategoryDto>();
                }
                catch {  }

                var itemToAdd = created ?? newCat;

                categories = new List<CategoryDto>(categories) { itemToAdd };

                showCreateModal = false;
                StateHasChanged(); 
            }
            else
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Помилка сервера: {response.StatusCode} - {errorBody}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Критична помилка в коді: {ex.Message}");
        }
    }
    private void CloseModal() => showEditModal = false;

    private async Task UpdateCategory()
    {
        await Http.PutAsJsonAsync($"api/v1/categories/{selectedCategory.Id}", selectedCategory);
        showEditModal = false;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        var result = await Http.GetFromJsonAsync<List<CategoryDto>>("api/v1/categories");
        if (result != null) categories = result;
    }

    private async Task SaveAllLimits()
    {
        var tasks = categories.Select(cat => Http.PutAsJsonAsync($"api/v1/categories/{cat.Id}", cat));
        await Task.WhenAll(tasks);
        Navigation.NavigateTo("/");
    }

    private string GetGlobalPercent(CategoryDto cat)
    {
        var total = categories.Sum(c => c.TotalLimit);
        if (total == 0) return "0";
        return ((double)cat.TotalLimit / (double)total * 100).ToString("F1", System.Globalization.CultureInfo.InvariantCulture);
    }

    private string GetCategoryColor(string name) => name?.Trim().ToLower() switch
    {
        "продукти" => "#FFD700",
        "покупки" => "#A020F0",
        "заклади харчування" => "#00CED1",
        "транспорт" => "#FF69B4",
        "здоров'я" => "#FF4500",
        "підписки" => "#4CAF50",
        _ => "#808080"
    };

    private string GetCategoryEmoji(string name) => name?.Trim().ToLower() switch
    {
        "продукти" => "🛒",
        "покупки" => "🛍️",
        "заклади харчування" => "🍴",
        "транспорт" => "🚗",
        "здоров'я" => "❤️",
        "підписки" => "🏷️",
        _ => "📦"
    };
}