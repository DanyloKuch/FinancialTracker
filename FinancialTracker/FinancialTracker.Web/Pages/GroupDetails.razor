@page "/group/{GroupId:guid}"
@using FinancialTracker.Web.Models
@using FinancialTracker.Web.Services
@inject FinancialService FinancialService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Nav

<div class="dashboard-wrapper">
    <div class="side-panel @(isSidebarOpen ? "open" : "")">
        <div class="panel-content">
            <div class="panel-header">
                @if (isOwner)
                {
                    <button class="icon-btn edit-members-btn"
                            @onclick="() => showSettings = true">
                        ⚙
                    </button>
                }

                <h3>Учасники групи</h3>

                <button class="close-btn" @onclick="ToggleSidebar">〈</button>
            </div>

            <div class="members-list">
                @if (currentGroup?.ParticipantNames != null)
                {
                    @* Ті, хто вже в групі *@
                    @foreach (var name in currentGroup.ParticipantNames)
                    {
                        <div class="member-row" style="display: flex; align-items: center; gap: 12px; width: 100%; padding-right: 10px; margin-bottom: 8px;">
                            <div class="member-avatar">@name[0].ToString().ToUpper()</div>
                            <span class="member-name" title="@name">@name</span>
                        </div>
                    }

                    @* Ті, хто ще думає (Pending) *@
                    @foreach (var invite in pendingInvitations)
                    {
                        <div class="member-row" style="display: flex; align-items: center; gap: 12px; width: 100%; padding-right: 10px; margin-bottom: 8px; opacity: 0.6;">
                            <div class="member-avatar" style="background: #333; border: 1px dashed #666; color: #888;">
                                @(string.IsNullOrEmpty(invite.InviteeEmail) ? "?" : invite.InviteeEmail[0].ToString().ToUpper())
                            </div>
                            <div style="display: flex; flex-direction: column; overflow: hidden;">
                                <span class="member-name" style="font-size: 0.85rem; color: #bbb;">
                                    @(invite.InviteeEmail ?? "Користувач")
                                </span>
                                <span style="font-size: 0.7rem; color: #cca300;">запрошення надіслано...</span>
                            </div>
                        </div>
                    }
                }
            </div>
           
            @if (showLeaveConfirm)
            {
                <div class="modal-overlay" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 20000; display: flex; align-items: center; justify-content: center;">
                    <div class="confirm-modal" style="background: #1a1a1a; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; border: 1px solid #333;">
                        <h3 style="color: white; margin-bottom: 15px;">Вийти з групи?</h3>
                        <p style="color: #888; margin-bottom: 25px;">Ви втратите доступ до спільних витрат та балансу цієї групи.</p>
                        <div style="display: flex; gap: 10px;">
                            <button @onclick="() => showLeaveConfirm = false" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: transparent; color: white;">Скасувати</button>
                            <button @onclick="ConfirmLeaveGroup" style="flex: 1; padding: 10px; border-radius: 8px; border: none; background: #ff4444; color: white; font-weight: bold;">Вийти</button>
                        </div>
                    </div>
                </div>
            }
            <div class="add-member-footer">
                <button class="add-member-btn"
                        @onclick="ShowAddMemberModal"
                @onclick:stopPropagation
                        style="position: relative; z-index: 10005; cursor: pointer;">
                    <span class="plus-sign">+</span> Додати до групи
                </button>
            </div>
        </div>
    </div>
    <header class="top-bar">
        <div class="header-left">
            <button class="icon-btn" @onclick='() => Nav.NavigateTo("/groups")'>←</button>
            <button class="icon-btn" @onclick="ToggleSidebar">👥</button>
        </div>

        <div class="group-title-center">
            <h2 style="margin:0; font-size: 1.1rem;">
                @currentGroup?.Name
            </h2>
        </div>

        <div class="group-actions">
            <span class="edit-icon" @onclick="() => OpenEditGroup(currentGroup)">✎</span>

            @if (currentGroup != null && !isOwner)
            {
                <button class="leave-group-pill" @onclick="() => showLeaveConfirm = true">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Вийти</span>
                </button>
            }
        </div>
    </header>
    <div class="dashboard-content">
        <div class="balance-section">
            <span class="label">Залишок бюджету групи</span>
            <h1 class="balance-amount">
                @currentBalance.ToString("N2") @GetCurrencySymbol(currentGroup?.BaseCurrency)
            </h1>
            <div class="progress-container" style="background: #222; height: 10px; border-radius: 10px; margin-top: 15px; width: 100%; overflow: hidden; border: 1px solid #333;">
                <div class="progress-fill"
                     style="width: @(progressPercentage.ToString("F0", System.Globalization.CultureInfo.InvariantCulture))%;
                    background: linear-gradient(90deg, #00E5FF, #448AFF);
                    height: 100%;
                    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
                    box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);">
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.85rem; color: #888;">
                <span>Витрачено: @totalSpent.ToString("N0") @GetCurrencySymbol(currentGroup?.BaseCurrency)</span>
                <span>Ліміт: @initialBank.ToString("N0") @GetCurrencySymbol(currentGroup?.BaseCurrency)</span>
            </div>
        </div>

        <div class="cards-row">
            <div class="action-card expense-card">
                <div class="card-top">
                    <button class="add-btn" @onclick="OpenAddExpense">📅 + Додати</button>
                </div>
                <div class="card-bottom">
                    <span>Загальні витрати</span>
                    <h3>@totalSpent.ToString("N2") @GetCurrencySymbol(currentGroup?.BaseCurrency)</h3>
                </div>
            </div>

        </div>
        <div class="main-grid">
            <div class="grid-col">
                <div class="section-header">
                    <h3>Останні транзакції групи</h3>
                </div>

                <div class="transactions-list">
                    @if (groupTransactions != null && groupTransactions.Any())
                    {
                        @foreach (var tx in groupTransactions)
                        {
                            <div class="trans-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #222;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="trans-icon-circle" style="background: #2a2a2a; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        🛒
                                    </div>
                                    <div class="trans-details">
                                        <div class="trans-title" style="color: white; font-weight: 500;">
                                            @(string.IsNullOrEmpty(tx.Comment) ? "Витрата групи" : tx.Comment)
                                        </div>
                                        <div class="trans-info" style="font-size: 0.8rem; display: flex; flex-direction: column; gap: 2px;">
                                            <span style="color: #888;">@tx.CreatedAt.ToString("dd MMMM, HH:mm")</span>

                                            @* Перевірка наявності email *@
                                            @if (!string.IsNullOrWhiteSpace(tx.userEmail))
                                            {
                                                <span style="color: #00E5FF; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                                    <span style="font-size: 0.7rem;">👤</span> @tx.userEmail
                                                </span>
                                            }
                                            else
                                            {
                                                <span style="color: #555; font-style: italic;">👤 Користувач не вказаний</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="trans-sum" style="color: #ff4444; font-weight: bold;">
                                    -@tx.Amount.ToString("N2") @GetCurrencySymbol(currentGroup?.BaseCurrency)
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div style="text-align: center; padding: 40px; color: #666;">
                            Транзакцій поки немає...
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" @onclick='() => Nav.NavigateTo("/")'><span class="nav-icon">👛</span><span>Баланс</span></div>
        <div class="nav-item"><span class="nav-icon">📈</span><span>Статистика</span></div>
        <div class="nav-item center-btn">
            <button class="plus-btn" @onclick="OpenAddExpense">+</button>
            <span>Витрата</span>
        </div>
        <div class="nav-item active" @onclick='() => Nav.NavigateTo("/groups")'><span class="nav-icon">👥</span><span>Групи</span></div>
        <div class="nav-item"><span class="nav-icon">•••</span><span>Більше</span></div>
    </nav>
</div>
<EditGroup IsVisible="showEditModal"
           Group="selectedGroup"
           OnClose="CloseEditModal"
           OnSave="HandleSaveGroup"
           OnDelete="HandleDeleteGroup" />

<AddParticipantModal IsVisible="showAddMemberModal"
                     GroupId="@GroupId.ToString()"
                     OnClose="CloseAddMemberModal" />

<EditParticipantsModal IsVisible="showSettings"
                       Group="currentGroup"
                       OnClose="() => showSettings = false"
                       OnSave="HandleSaveParticipants" />

@code {

    [Parameter] public Guid GroupId { get; set; }
    [CascadingParameter] private Task<AuthenticationState> AuthState { get; set; }
    private bool showLeaveConfirm = false;
    private string? currentUserId;
    private bool showSettings = false;
    private GroupDto? currentGroup;
    private List<TransactionDto> groupTransactions = new();
    private bool showEditModal = false;
    private GroupDto? selectedGroup = null;
    private bool showAddMemberModal = false;
    private bool isSidebarOpen = false;
    private bool isOwner = false;
    private decimal initialBank = 0;
    private decimal totalSpent = 0;
    private decimal currentBalance = 0;
    private double progressPercentage = 0;
    private string? deleteErrorMessage;
    private List<InvitationDto> pendingInvitations = new();

    protected override async Task OnInitializedAsync()
    {
        currentUserId = await LocalStorage.GetItemAsync<string>("userId");
        await LoadData();
    }

    private async Task LoadData()
    {
        var groups = await FinancialService.GetGroupsAsync();
        currentGroup = groups.FirstOrDefault(g => g.Id == GroupId.ToString());

        if (currentGroup != null)
        {
            isOwner = currentGroup.IsOwner;
            initialBank = currentGroup.TotalLimit ?? 0;
            groupTransactions = await FinancialService.GetGroupTransactionsAsync(GroupId);
            groupTransactions = groupTransactions.OrderByDescending(t => t.CreatedAt).ToList();

            totalSpent = groupTransactions.Where(t => t.Type == 1).Sum(t => t.Amount);
            currentBalance = initialBank - totalSpent;

            if (initialBank > 0)
            {
                progressPercentage = (double)((totalSpent / initialBank) * 100);
                if (progressPercentage > 100) progressPercentage = 100;
                if (progressPercentage < 0) progressPercentage = 0;
            }
            else
            {
                progressPercentage = 0;
            }
        }
        var allSentInvites = await FinancialService.GetSentInvitationsAsync();
        pendingInvitations = allSentInvites
            .Where(i => i.GroupId == GroupId && i.Status == "Pending")
            .ToList();
    }

    private async Task HandleSaveParticipants(List<string> updatedIds)
    {
        if (currentGroup == null) return;
        var membersToKick = currentGroup.Members
            .Where(m => !updatedIds.Contains(m.UserId.ToString()))
            .ToList();

        bool allSuccess = true;
        foreach (var member in membersToKick)
        {
            var success = await FinancialService.KickMemberAsync(currentGroup.Id, member.UserId.ToString());
            if (!success)
            {
                allSuccess = false;
            }
        }
        if (allSuccess)
        {
            showSettings = false;
            await LoadData(); 
        }
        else
        {
            await LoadData();
            StateHasChanged();
        }

        if (!isOwner) return;

    }

    private void ShowAddMemberModal()
    {
        showAddMemberModal = true;
        StateHasChanged();
    }

    private async Task CloseAddMemberModal()
    {
        showAddMemberModal = false;
        await LoadData();
        StateHasChanged();
    }

    private void ToggleSidebar() => isSidebarOpen = !isSidebarOpen;
    private void OpenEditGroup(GroupDto group)
    {
        selectedGroup = group;
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedGroup = null;
    }

    private async Task HandleSaveGroup(GroupDto updatedGroup)
    {
        var success = await FinancialService.UpdateGroupAsync(updatedGroup);
        if (success)
        {
            currentGroup = updatedGroup;
            await LoadData();
           
        }
    }

    private async Task HandleDeleteGroup(string groupId)
    {
        deleteErrorMessage = null; 
        var (success, message) = await FinancialService.DeleteGroupAsync(groupId);

        if (success)
        {
            CloseEditModal();
            Nav.NavigateTo("/groups");
        }
        else
        {
            deleteErrorMessage = message;
            StateHasChanged();
        }
    }

    private void OpenAddExpense()
    {
        Nav.NavigateTo($"/add-group-expense/{GroupId}");
    }

    private string GetCurrencySymbol(string? currencyCode)
    {
        return currencyCode?.ToUpper() switch
        {
            "USD" => "$",
            "EUR" => "€",
            "UAH" => "₴",
            _ => currencyCode ?? "₴"
        };
    }

    private async Task ConfirmLeaveGroup()
    {
        if (currentGroup == null || isOwner)
        {
            showLeaveConfirm = false;
            return;
        }

        var success = await FinancialService.LeaveGroupAsync(currentGroup.Id);

        if (success)
        {
            showLeaveConfirm = false;
            Nav.NavigateTo("/groups"); 
        }
        else
        {
            showLeaveConfirm = false;
        }
    }

}

