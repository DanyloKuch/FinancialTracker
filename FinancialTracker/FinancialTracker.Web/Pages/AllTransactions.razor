@page "/transactions"
@using FinancialTracker.Web.Models
@using FinancialTracker.Web.Services
@inject FinancialService FinancialService
@inject NavigationManager Nav

<div class="transactions-page">
    <header class="page-header">
        <button class="back-btn" @onclick='() => Nav.NavigateTo("/")'>←</button>
        <h2 class="page-title">Всі транзакції</h2>
        <button class="add-plus-btn" @onclick='() => Nav.NavigateTo("/add-transaction/1")'>+</button>
    </header>

    <div class="summary-section">
        <div class="total-label">Всього операцій: @totalCount</div>
    </div>

    <div class="transactions-container">
        @if (transactions == null)
        {
            <div class="loading-spinner">Завантаження...</div>
        }
        else if (!transactions.Any())
        {
            <div class="empty-state">Транзакцій поки немає</div>
        }
        else
        {
            <div class="transactions-grid">
                @foreach (var tx in transactions)
                {
                    bool isIncome = tx.Type == 0;
                    bool isTransfer = tx.Type == 2;
                    string accentColor = isIncome ? "#4caf50" : GetRandomAccentColor(tx.Id);
                    string sign = isIncome ? "+" : "-";

                    <div class="transaction-card" @onclick="() => OpenEditModal(tx)">
                        <div class="icon-wrapper" style="border-color: @accentColor">
                            <span class="icon">@(isTransfer ? "⇄" : (isIncome ? "💰" : "🛒"))</span>
                        </div>
                        <div class="details">
                            <div class="main-info">
                                <span class="title">@(string.IsNullOrEmpty(tx.Comment) ? "Транзакція" : tx.Comment)</span>
                                <span class="amount">
                                    @if (isTransfer)
                                    {
                                        <span>&lt;=&gt; </span>
                                    }
                                    @sign@Math.Abs(tx.Amount).ToString("N0")
                                </span>
                            </div>
                            <div class="sub-info">
                                <span class="date">@tx.CreatedAt.ToString("dd.MM.yyyy HH:mm")</span>
                                <span class="percent">@GetPercent(tx.Amount)%</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>

    <footer class="pagination-footer">
        <button class="pager-btn" disabled="@(currentPage == 1)" @onclick="PreviousPage">← Назад</button>
        <span class="page-info">Сторінка @currentPage з @totalPages</span>
        <button class="pager-btn" disabled="@(currentPage >= totalPages)" @onclick="NextPage">Вперед →</button>
    </footer>

    @if (showEditModal && selectedTransaction != null)
    {
        <div class="modal-backdrop" @onclick="CloseEditModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>Редагування транзакції</h3>
                    <button class="close-btn" @onclick="CloseEditModal">✕</button>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label>Гаманець</label>
                        <select @bind="editModel.WalletId" class="form-control">
                            @foreach (var wallet in wallets)
                            {
                                <option value="@wallet.Id">@wallet.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Сума</label>
                        <input type="number" @bind="editModel.Amount" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Категорія</label>
                        <select @bind="editModel.CategoryId" class="form-control">
                            @foreach (var cat in categories)
                            {
                                <option value="@cat.Id">@cat.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Коментар</label>
                        <input type="text" @bind="editModel.Comment" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Цільовий гаманець (для переказу)</label>
                        <select @bind="editModel.TargetWalletId" class="form-control">
                            <option value="">Не обрано</option>
                            @foreach (var wallet in wallets)
                            {
                                <option value="@wallet.Id">@wallet.Name</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Курс обміну</label>
                        <input type="number" step="0.01" @bind="editModel.ExchangeRate" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Комісія</label>
                        <input type="number" step="0.01" @bind="editModel.Commission" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Тип транзакції</label>
                        <select @bind="editModel.Type" class="form-control">
                            <option value="0">Дохід</option>
                            <option value="1">Витрата</option>
                            <option value="2">Переказ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Дата та час транзакції</label>
                        <input type="datetime-local" @bind="editModel.CreatedAt" class="form-control" />
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-delete" @onclick="DeleteTransaction">Видалити</button>
                    <button class="btn-cancel" @onclick="CloseEditModal">Скасувати</button>
                    <button class="btn-save" @onclick="SaveTransaction">Зберегти</button>
                </div>
            </div>
        </div>
    }
</div>


@code {
    private List<TransactionDto> transactions;
    private List<WalletDto> wallets = new();
    private List<CategoryDto> categories = new();
    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 15;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    private bool showEditModal = false;
    private TransactionDto selectedTransaction;
    private TransactionUpdateDto editModel = new();

    protected override async Task OnInitializedAsync()
    {
        wallets = await FinancialService.GetWalletsAsync();
        categories = await FinancialService.GetCategoriesAsync();
        await LoadPage();
    }

    private async Task LoadPage()
    {
        var result = await FinancialService.GetTransactionsAsync(currentPage, pageSize);
        transactions = result.Items;
        totalCount = result.TotalCount;
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadPage();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadPage();
        }
    }

    private void OpenEditModal(TransactionDto transaction)
    {
        selectedTransaction = transaction;
        editModel = new TransactionUpdateDto
        {
            WalletId = transaction.WalletId,
            Amount = transaction.Amount,
            CategoryId = transaction.CategoryId ?? Guid.Empty,
            Comment = transaction.Comment,
            TargetWalletId = transaction.TargetWalletId,
            ExchangeRate = null,
            Commission = null,
            Type = transaction.Type,
            CreatedAt = transaction.CreatedAt

        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedTransaction = null;
    }

    private async Task SaveTransaction()
    {
        if (selectedTransaction != null)
        {
            var success = await FinancialService.UpdateTransactionAsync(selectedTransaction.Id, editModel);
            if (success)
            {
                await LoadPage();
                CloseEditModal();
            }
        }
    }

    private async Task DeleteTransaction()
    {
        if (selectedTransaction != null)
        {
            var success = await FinancialService.DeleteTransactionAsync(selectedTransaction.Id);
            if (success)
            {
                await LoadPage();
                CloseEditModal();
            }
        }
    }

    private string GetRandomAccentColor(Guid id)
    {
        var colors = new[] { "#ffeb3b", "#e91e63", "#f44336", "#00bcd4", "#9c27b0" };
        var index = Math.Abs(id.GetHashCode()) % colors.Length;
        return colors[index];
    }

    private string GetPercent(decimal amount)
    {
        return new Random().Next(5, 25).ToString();
    }
}