@page "/expense-analysis"
@using FinancialTracker.Web.Models
@using FinancialTracker.Web.Services
@inject FinancialService FinancialService
@inject NavigationManager Nav

<div class="expense-analysis-wrapper">
    <header class="analysis-header">
        <button class="back-btn" @onclick='() => Nav.NavigateTo("/")'>
            <span class="icon-wrapper">←</span>
        </button>
        <h2 class="page-title">Витрати</h2>
        <button class="add-btn" @onclick='() => Nav.NavigateTo("/add-transaction/1")'>
            <span class="plus-icon">+</span>
        </button>
    </header>

    <div class="total-expenses">
        <h1 class="total-amount">@totalExpenses.ToString("N0") ₴</h1>
        <div class="color-bar">
            @if (GetColorSegments().Any())
            {
                @foreach (var segment in GetColorSegments())
                {
                    <div class="bar-segment"
                         style="width: @segment.Percentage.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%; background-color: @segment.Color;">
                    </div>
                }
            }
            else
            {
                <div class="bar-segment" style="width: 100%; background-color: #333;"></div>
            }
        </div>
    </div>

    <div class="categories-grid">
        @if (categories == null)
        {
            <div class="loading-container">
                <p>Завантаження даних...</p>
            </div>
        }
        else if (!categories.Any(c => c.SpentAmount > 0))
        {
            <p class="empty-text">У вас ще немає витрат у цьому періоді.</p>
        }
        else
        {
            @foreach (var cat in categories.Where(c => c.SpentAmount > 0).OrderByDescending(c => c.SpentAmount))
            {
                <div class="category-card" style="opacity: @(cat.SpentAmount > 0 ? "1" : "0.5")">
                    <div class="cat-icon-circle" style="background: @GetCategoryColor(cat.Name);">
                        @GetCategoryIcon(cat.Name)
                    </div>
                    <div class="cat-info">
                        <span class="cat-name">@cat.Name</span>
                        <span class="cat-percent">@GetPercentOfTotal(cat.SpentAmount)%</span>
                    </div>
                    <div class="cat-amount">
                        <span>-@cat.SpentAmount.ToString("N1")</span>
                    </div>
                </div>
            }
        }
    </div>
</div>


@code {
    private List<CategoryDto>? categories;
    private decimal totalExpenses = 0;

    protected override async Task OnInitializedAsync()
    {
        var summary = await FinancialService.GetDashboardSummaryAsync();
        if (summary != null)
        {
            categories = summary.Categories;
            totalExpenses = categories?.Where(c => c.SpentAmount > 0).Sum(c => c.SpentAmount) ?? 0;
        }
    }

    private int GetPercentOfTotal(decimal amount)
    {
        if (totalExpenses == 0) return 0;
        return (int)Math.Round((amount / totalExpenses) * 100);
    }

    private List<(decimal Percentage, string Color)> GetColorSegments()
    {
        if (categories == null || totalExpenses == 0)
            return new List<(decimal, string)>();

        var segments = new List<(decimal Percentage, string Color)>();
        var sortedCategories = categories.Where(c => c.SpentAmount > 0)
                                         .OrderByDescending(c => c.SpentAmount)
                                         .ToList();

        var colors = new[] { "#f59e0b", "#ec4899", "#ef4444", "#06b6d4", "#8b5cf6", "#10b981" };

        for (int i = 0; i < sortedCategories.Count; i++)
        {
            var percentage = (sortedCategories[i].SpentAmount / totalExpenses) * 100;
            var color = colors[i % colors.Length];
            segments.Add((percentage, color));
        }

        return segments;
    }

    private string GetCategoryColor(string categoryName)
    {
        return categoryName?.ToLower() switch
        {
            var n when n.Contains("продукт") || n.Contains("їжа") => "rgba(245, 158, 11, 0.2)",
            var n when n.Contains("транспорт") => "rgba(168, 85, 247, 0.2)",
            var n when n.Contains("здоров") => "rgba(239, 68, 68, 0.2)",
            var n when n.Contains("заклад") || n.Contains("ресторан") => "rgba(6, 182, 212, 0.2)",
            var n when n.Contains("догляд") => "rgba(107, 114, 128, 0.2)",
            var n when n.Contains("освіта") => "rgba(107, 114, 128, 0.2)",
            var n when n.Contains("покупки") => "rgba(107, 114, 128, 0.2)",
            var n when n.Contains("підписк") => "rgba(107, 114, 128, 0.2)",
            _ => "rgba(107, 114, 128, 0.2)"
        };
    }

    private string GetCategoryIcon(string categoryName)
    {
        return categoryName?.ToLower() switch
        {
            var n when n.Contains("продукт") || n.Contains("їжа") => "🛒",
            var n when n.Contains("транспорт") => "🚗",
            var n when n.Contains("здоров") => "❤️",
            var n when n.Contains("заклад") || n.Contains("ресторан") => "🍽️",
            var n when n.Contains("догляд") => "👔",
            var n when n.Contains("освіта") => "🎓",
            var n when n.Contains("покупки") => "🔒",
            var n when n.Contains("підписк") => "🔄",
            _ => "📂"
        };
    }
}
